<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Orville - Using Plans</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
    </head>
    <body>
      <section class="leftbar">
        <header>
          <h1 class="logo">
            <a href="../">
              <img alt="Orville Logo" src="../images/orville-waving-pennant.svg" />
            </a>
          </h1>
        </header>

        <nav>
          <h3><a href="../">Home</a></h3>

          <h3>Tutorials</h3>
          
            <a href="../tutorials/getting-started.html">Getting Started</a>
          
            <a href="../tutorials/using-sql-marshaller.html">Using SqlMarshaller</a>
          
            <a href="../tutorials/using-migrations.html">Using Migrations</a>
          
            <a href="../tutorials/using-plans.html">Using Plans</a>
          
            <a href="../tutorials/using-json.html">Using JSON</a>
          

          <h3>How-To Guides</h3>
          
            <a href="../how-tos/how-to-add-orville-to-your-application-monad.html">How To Add Orville to Your Application Monad</a>
          
            <a href="../how-tos/how-to-add-orville-to-an-existing-reader-context.html">How To Add Orville to an Existing Reader Context</a>
          
            <a href="../how-tos/how-to-marshall-a-haskell-record.html">How To Marshall a Haskell Record (Upcoming)</a>
          
            <a href="../how-tos/how-to-add-custom-marshalling-validations.html">How Add Custom Marshalling Validations (Upcoming)</a>
          
            <a href="../how-tos/how-to-marshall-a-haskell-sum-type.html">How To Marshall a Haskell Sum Type (Upcoming)</a>
          
            <a href="../how-tos/how-to-set-up-an-auto-incrementing-id-column.html">How To Set Up An Auto-incrementing Id Column (Upcoming)</a>
          
            <a href="../how-tos/how-to-execute-raw-sql.html">How To Execute Raw SQL (Upcoming)</a>
          

          <h3>Futher Explanation</h3>
          
            <a href="../explanations/the-monad-orville-typeclass.html">The MonadOrville Typeclass (Upcoming)</a>
          
            <a href="../explanations/building-sql-expressions.html">Building SQL Expressions (Upcoming)</a>
          
            <a href="../explanations/fighting-n-plus-one-queries-with-plans.html">Fighting N+1 Queries with Plans (Upcoming)</a>
          
            <a href="../explanations/handling-failure.html">Handling Failure (Upcoming)</a>
          

          <h3>API Reference</h3>
          <a href="https://hackage.haskell.org/package/orville-postgresql">See Hackage</a>

          <h3>Other Links</h3>
          <a href="../contact.html">Contact</a>
        </nav>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
      </section>

      <main role="main">
        <h1>Using Plans</h1>
        <article>
  <section>
    <p>You’ll need a Haskell project named <code>using-plans</code> for this tutorial.
The setup is identical to the setup in <a href="getting-started.html">Getting Started</a>
aside from the package name, so we’ll avoid explaining it again here.</p>
<p>This example shows Plans. A Plan contains one or more SQL select statements,
and when the first is run, its result is passed into the next.</p>
<p>The goal of plans is to prevent <a href="https://secure.phabricator.com/book/phabcontrib/article/n_plus_one/">n+1
queries</a>,
while still allowing a plan for a single item to be modified to execute against
many items.</p>
<p>The code contains a detailed description, this document will just focus on
examples.</p>
<p>This example has a table with students, and a table with classes they can take.</p>
<p>Because multiple students can be enrolled in multiple classes, it is a
many-to-many relationship, which can be modelled with a separate table with two
foreign keys on it.</p>
<p>These tables are defined in a manner similar to previous tutorials. Note the
foreign keys on the <code>student_class</code> table. Begin your <code>src/Main.hs</code> like this:</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  ( main</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">where</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Orville.PostgreSQL</span> <span class="kw">as</span> <span class="dt">O</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Orville.PostgreSQL.AutoMigration</span> <span class="kw">as</span> <span class="dt">AutoMigration</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Orville.PostgreSQL.Plan</span> <span class="kw">as</span> <span class="dt">Plan</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.List</span> (sort)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Data.List.NonEmpty</span> (<span class="dt">NonEmpty</span>((:|)))</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Int</span> <span class="kw">as</span> <span class="dt">Int</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Text</span> <span class="kw">as</span> <span class="dt">T</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">-------------</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">-- Student --</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">-------------</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">StudentId</span> <span class="ot">=</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">StudentName</span> <span class="ot">=</span> <span class="dt">T.Text</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">type</span> <span class="dt">StudentAge</span> <span class="ot">=</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Student</span> <span class="ot">=</span> <span class="dt">Student</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> studentId ::</span> <span class="dt">StudentId</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> studentName ::</span> <span class="dt">StudentName</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> studentAge ::</span> <span class="dt">StudentAge</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="ot">studentIdField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">StudentId</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>studentIdField <span class="ot">=</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;id&quot;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="ot">studentNameField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">StudentName</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>studentNameField <span class="ot">=</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  O.unboundedTextField <span class="st">&quot;name&quot;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="ot">studentAgeField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">StudentAge</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>studentAgeField <span class="ot">=</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;age&quot;</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="ot">studentMarshaller ::</span> <span class="dt">O.SqlMarshaller</span> <span class="dt">Student</span> <span class="dt">Student</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>studentMarshaller <span class="ot">=</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Student</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> O.marshallField studentId studentIdField</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField studentName studentNameField</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField studentAge studentAgeField</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="ot">studentTable ::</span> <span class="dt">O.TableDefinition</span> (<span class="dt">O.HasKey</span> <span class="dt">StudentId</span>) <span class="dt">Student</span> <span class="dt">Student</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>studentTable <span class="ot">=</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  O.mkTableDefinition <span class="st">&quot;plan_demo_student&quot;</span> (O.primaryKey studentIdField) studentMarshaller</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co">----------------------------</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="co">-- Student to Class Table --</span></span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="co">----------------------------</span></span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="ot">studentClassIdField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>studentClassIdField <span class="ot">=</span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;id&quot;</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="ot">studentClassClassIdField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>studentClassClassIdField <span class="ot">=</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;class_id&quot;</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="ot">studentClassStudentIdField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>studentClassStudentIdField <span class="ot">=</span></span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;student_id&quot;</span></span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">StudentClass</span> <span class="ot">=</span> <span class="dt">StudentClass</span></span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> studentClassId ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> studentClassClassId ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> studentClassStudentId ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="ot">studentClassMarshaller ::</span> <span class="dt">O.SqlMarshaller</span> <span class="dt">StudentClass</span> <span class="dt">StudentClass</span></span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>studentClassMarshaller <span class="ot">=</span></span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>  <span class="dt">StudentClass</span></span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> O.marshallField studentClassId studentClassIdField</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField studentClassClassId studentClassClassIdField</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField studentClassStudentId studentClassStudentIdField</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="ot">studentClassTable ::</span> <span class="dt">O.TableDefinition</span> (<span class="dt">O.HasKey</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span>) <span class="dt">StudentClass</span> <span class="dt">StudentClass</span></span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>studentClassTable <span class="ot">=</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>  O.addTableConstraints</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>    [ O.foreignKeyConstraint (O.tableIdentifier classTable) <span class="op">$</span></span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>        O.foreignReference (O.fieldName studentClassClassIdField) (O.fieldName classIdField) <span class="op">:|</span> []</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>    , O.foreignKeyConstraint (O.tableIdentifier studentTable) <span class="op">$</span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>        O.foreignReference (O.fieldName studentClassStudentIdField) (O.fieldName studentIdField) <span class="op">:|</span> []</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>  <span class="op">$</span> O.mkTableDefinition <span class="st">&quot;plan_demo_student_class&quot;</span> (O.primaryKey studentClassIdField) studentClassMarshaller</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="co">-----------</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="co">-- Class --</span></span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="co">-----------</span></span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a><span class="ot">classIdField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>classIdField <span class="ot">=</span></span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;id&quot;</span></span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a><span class="ot">classSubjectField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">T.Text</span></span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>classSubjectField <span class="ot">=</span></span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>  O.unboundedTextField <span class="st">&quot;subject&quot;</span></span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Class</span> <span class="ot">=</span> <span class="dt">Class</span></span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> classId ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> classSubject ::</span> <span class="dt">T.Text</span></span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> (<span class="dt">Show</span>, <span class="dt">Eq</span>, <span class="dt">Ord</span>)</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a><span class="ot">classMarshaller ::</span> <span class="dt">O.SqlMarshaller</span> <span class="dt">Class</span> <span class="dt">Class</span></span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>classMarshaller <span class="ot">=</span></span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Class</span></span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> O.marshallField classId classIdField</span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField classSubject classSubjectField</span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a><span class="ot">classTable ::</span> <span class="dt">O.TableDefinition</span> (<span class="dt">O.HasKey</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span>) <span class="dt">Class</span> <span class="dt">Class</span></span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>classTable <span class="ot">=</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>  O.mkTableDefinition <span class="st">&quot;plan_demo_class&quot;</span> (O.primaryKey classIdField) classMarshaller</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>The three tables are declared, we’ll proceed to the <code>main</code> function, which
ensures some sample data is available, and then queries it in different ways.</p>
<p>Since we have foreign key constraints, we have to create and delete the data in
an order that doesn’t violate these constraints. Orville will throw a Haskell
runtime exception upon execution of an SQL statement that violates a
constraint.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  pool <span class="ot">&lt;-</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    O.createConnectionPool</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">O.ConnectionOptions</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>          { O.connectionString <span class="ot">=</span> <span class="st">&quot;host=localhost user=postgres password=postgres&quot;</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>          , O.connectionNoticeReporting <span class="ot">=</span> <span class="dt">O.DisableNoticeReporting</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>          , O.connectionPoolStripes <span class="ot">=</span> <span class="dt">O.OneStripePerCapability</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>          , O.connectionPoolLingerTime <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>          , O.connectionPoolMaxConnections <span class="ot">=</span> <span class="dt">O.MaxConnectionsPerStripe</span> <span class="dv">1</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  O.runOrville pool <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    AutoMigration.autoMigrateSchema AutoMigration.defaultOptions [<span class="dt">AutoMigration.SchemaTable</span> studentTable, <span class="dt">AutoMigration.SchemaTable</span> classTable, <span class="dt">AutoMigration.SchemaTable</span> studentClassTable]</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity studentClassTable <span class="dv">0</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity studentClassTable <span class="dv">1</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity studentClassTable <span class="dv">2</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity classTable <span class="dv">0</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity classTable <span class="dv">1</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity classTable <span class="dv">2</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity studentTable <span class="dv">0</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.deleteEntity studentTable <span class="dv">1</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity studentTable <span class="dt">Student</span> { studentId <span class="ot">=</span> <span class="dv">0</span>, studentName <span class="ot">=</span> T.pack <span class="st">&quot;Name&quot;</span>, studentAge <span class="ot">=</span> <span class="dv">91</span> }</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity studentTable <span class="dt">Student</span> { studentId <span class="ot">=</span> <span class="dv">1</span>, studentName <span class="ot">=</span> T.pack <span class="st">&quot;Other Name&quot;</span>, studentAge <span class="ot">=</span> <span class="dv">42</span> }</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity classTable <span class="dt">Class</span> { classId <span class="ot">=</span> <span class="dv">0</span>, classSubject <span class="ot">=</span> T.pack <span class="st">&quot;Painting&quot;</span> }</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity classTable <span class="dt">Class</span> { classId <span class="ot">=</span> <span class="dv">1</span>, classSubject <span class="ot">=</span> T.pack <span class="st">&quot;Cooking&quot;</span> }</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity classTable <span class="dt">Class</span> { classId <span class="ot">=</span> <span class="dv">2</span>, classSubject <span class="ot">=</span> T.pack <span class="st">&quot;Swimming&quot;</span> }</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity studentClassTable <span class="op">$</span> <span class="dt">StudentClass</span> {studentClassId<span class="ot">=</span><span class="dv">0</span>, studentClassClassId<span class="ot">=</span><span class="dv">0</span>, studentClassStudentId<span class="ot">=</span><span class="dv">0</span>}</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity studentClassTable <span class="op">$</span> <span class="dt">StudentClass</span> {studentClassId<span class="ot">=</span><span class="dv">1</span>, studentClassClassId<span class="ot">=</span><span class="dv">2</span>, studentClassStudentId<span class="ot">=</span><span class="dv">0</span>}</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity studentClassTable <span class="op">$</span> <span class="dt">StudentClass</span> {studentClassId<span class="ot">=</span><span class="dv">2</span>, studentClassClassId<span class="ot">=</span><span class="dv">1</span>, studentClassStudentId<span class="ot">=</span><span class="dv">1</span>}</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">pure</span> ()</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Now that the data is available, let’s first show off a simple plan which is
already more powerful than <code>findEntity</code>. <code>findMaybeOne</code> takes the table, and
the field to filter on, where as <code>findEntity</code> only works using the primary key.</p>
<p>The plan returned by <code>findMaybeOne</code> is like a parameterized query, it doesn’t
yet contain the actual value to filter for.</p>
<p>But upon execution, that value has to be provided, and it has to match the type
of the Plan. <code>execute</code> is in MonadOrville just like <code>findEntity</code>, so from here
on out, it is familiar territory.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span> <span class="op">=&lt;&lt;</span> O.runOrville pool (Plan.execute (Plan.findMaybeOne studentTable studentIdField) <span class="dv">0</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Just to demonstrate that you can filter on other fields too, let’s search for a
specific student using their name. Note that Orville doesn’t have any
type-level checks for whether there is an index on the field.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span> <span class="op">=&lt;&lt;</span> O.runOrville pool (Plan.execute (Plan.findMaybeOne studentTable studentNameField) (T.pack <span class="st">&quot;Other Name&quot;</span>))</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>A plan that takes a single argument and returns a single argument can be passed
into <code>planList</code> to make it work on multiple values. Note how <code>execute</code> now
takes a list instead of just a single value.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span> <span class="op">=&lt;&lt;</span> O.runOrville pool (Plan.execute (Plan.planList (Plan.findMaybeOne studentTable studentNameField)) [T.pack <span class="st">&quot;Other Name&quot;</span>, T.pack <span class="st">&quot;Name&quot;</span>])</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Remember how a plan is just a list of SQL statements. This can used in a way
similar to how <code>JOIN</code> is used in SQL.</p>
<p>The function <code>chain</code> is used to chain these statements together. After the
first statement is executed and its result has been sent to the client, Orville
allows for manipulating the value with <code>focusParam</code> before using it in a step.</p>
<p>For simplicity, we’ll use <code>findOne</code> here which is like <code>findMaybeOne</code>, but
throws exceptions when it fails to find something. In practice, make sure to
only use <code>findOne</code> when there are constraints or there is otherwise certainty
that a row exists.</p>
<p>The following plan will:
1. find a student, given a name. Since this is the first step of the plan, the
name is the input of the plan.
1. using the ID of the student, find a row in <code>student_class</code> that matches on
the <code>studentClassStudentIdField</code>. Note that Orville doesn’t check that the
fields are actually comparable, or that it makes sense to compare them!
1. using the ID of the <code>StudentClass</code>, find a row in <code>class</code> that matches on the <code>class_id</code>.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">print</span> <span class="op">=&lt;&lt;</span>) <span class="op">.</span> O.runOrville pool <span class="op">$</span> Plan.execute</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    (              Plan.findOne studentTable studentNameField</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>      <span class="ot">`Plan.chain`</span> Plan.focusParam studentId (Plan.findOne studentClassTable studentClassStudentIdField)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="ot">`Plan.chain`</span> Plan.focusParam studentClassClassId (Plan.findOne classTable classIdField)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    (T.pack <span class="st">&quot;Other Name&quot;</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Expanding on the previous example, let’s find all the names of the classes they
attend, instead of just one. This also lets us avoid unsafe uses of <code>findOne</code>.
This new version doesn’t throw an exception if a student doesn’t attend any
classes, which would happen when the middle plan would fail. Because of the
constraint, the final plan can’t fail, so that <code>findOne</code> kept.</p>
<p>Let’s extract the <code>Student -&gt; [Class]</code> part to its own Plan, which we’ll then
use for the final expression. Note how the following definition is similar to
the last two lines of the plan above.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ot">    studentToClassesPlan ::</span> <span class="dt">Plan.Plan</span> scope <span class="dt">Student</span> [<span class="dt">Class</span>]</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    studentToClassesPlan <span class="ot">=</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                   Plan.focusParam studentId (Plan.findAll studentClassTable studentClassStudentIdField)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>      <span class="ot">`Plan.chain`</span> Plan.planList (Plan.focusParam studentClassClassId <span class="op">$</span> Plan.findOne classTable classIdField)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Remember how plans solve the n+1 problem by scaling easily from a single item
to multiple items. This means that while <code>studentToClassesPlan</code> executes as two
SQL statements, <code>planList studentToClassesPlan</code>, a version that works on
multiple elements, <em>also</em> executes as two SQL statements.</p>
<p>You can verify this using <code>explain</code>, which shows the generated SQL. Note how
both of these lists have two SQL statements in them:</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span> <span class="op">$</span> Plan.explain studentToClassesPlan</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span> <span class="op">$</span> Plan.explain (Plan.planList studentToClassesPlan)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>With that in mind, let’s use <code>studentToClassesPlan</code> with <code>findAll</code> and
<code>planList</code> to get a list of classes for each matching student.</p>
<p>(we sort the inner lists below, such that the result is deterministic.)</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>  (<span class="fu">print</span> <span class="op">=&lt;&lt;</span>) <span class="op">.</span> <span class="fu">fmap</span> (<span class="fu">fmap</span> <span class="fu">sort</span>) <span class="op">.</span> O.runOrville pool <span class="op">$</span> Plan.execute</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    ( Plan.findAll studentTable studentNameField</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>      <span class="ot">`Plan.chain`</span> Plan.planList studentToClassesPlan</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    (T.pack <span class="st">&quot;Name&quot;</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>You can build an execute this as usual:</p>
<div class="codeblock-label">
shell
</div>
<div class="sourceCode" id="cb10"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> build</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> exec using-plans</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>And you should see the following output:</p>
<div class="codeblock-label">
output : plaintext
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Just (Student {studentId = 0, studentName = &quot;Name&quot;, studentAge = 91})</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>Just (Student {studentId = 1, studentName = &quot;Other Name&quot;, studentAge = 42})</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>[Just (Student {studentId = 1, studentName = &quot;Other Name&quot;, studentAge = 42}),Just (Student {studentId = 0, studentName = &quot;Name&quot;, studentAge = 91})]</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>Class {classId = 1, classSubject = &quot;Cooking&quot;}</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>[&quot;SELECT \&quot;student_id\&quot;,\&quot;id\&quot;,\&quot;class_id\&quot;,\&quot;student_id\&quot; FROM \&quot;plan_demo_student_class\&quot; WHERE (\&quot;student_id\&quot;) = ($1)&quot;,&quot;SELECT \&quot;id\&quot;,\&quot;id\&quot;,\&quot;subject\&quot; FROM \&quot;plan_demo_class\&quot; WHERE (\&quot;id\&quot;) IN ($1, $2)&quot;]</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>[&quot;SELECT \&quot;student_id\&quot;,\&quot;id\&quot;,\&quot;class_id\&quot;,\&quot;student_id\&quot; FROM \&quot;plan_demo_student_class\&quot; WHERE (\&quot;student_id\&quot;) IN ($1, $2)&quot;,&quot;SELECT \&quot;id\&quot;,\&quot;id\&quot;,\&quot;subject\&quot; FROM \&quot;plan_demo_class\&quot; WHERE (\&quot;id\&quot;) IN ($1, $2)&quot;]</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>[[Class {classId = 0, classSubject = &quot;Painting&quot;},Class {classId = 2, classSubject = &quot;Swimming&quot;}]]</span></code></pre></div>
  </section>
</article>

      </main>
    </body>
</html>

<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Orville - Using Migrations</title>
        <link rel="stylesheet" href="../css/syntax.css" />
        <link rel="stylesheet" href="../css/default.css" />
    </head>
    <body>
      <section class="leftbar">
        <header>
          <h1 class="logo">
            <a href="../">
              <img alt="Orville Logo" src="../images/orville-waving-pennant.svg" />
            </a>
          </h1>
        </header>

        <nav>
          <h3><a href="../">Home</a></h3>

          <h3>Tutorials</h3>
          
            <a href="../tutorials/getting-started.html">Getting Started</a>
          
            <a href="../tutorials/using-sql-marshaller.html">Using SqlMarshaller</a>
          
            <a href="../tutorials/using-migrations.html">Using Migrations</a>
          
            <a href="../tutorials/using-plans.html">Using Plans</a>
          
            <a href="../tutorials/using-json.html">Using JSON</a>
          

          <h3>How-To Guides</h3>
          
            <a href="../how-tos/how-to-add-orville-to-your-application-monad.html">How To Add Orville to Your Application Monad</a>
          
            <a href="../how-tos/how-to-marshall-a-haskell-record.html">How To Marshall a Haskell Record (Upcoming)</a>
          
            <a href="../how-tos/how-to-add-custom-marshalling-validations.html">How Add Custom Marshalling Validations (Upcoming)</a>
          
            <a href="../how-tos/how-to-marshall-a-haskell-sum-type.html">How To Marshall a Haskell Sum Type (Upcoming)</a>
          
            <a href="../how-tos/how-to-set-up-an-auto-incrementing-id-column.html">How To Set Up An Auto-incrementing Id Column (Upcoming)</a>
          
            <a href="../how-tos/how-to-execute-raw-sql.html">How To Execute Raw SQL (Upcoming)</a>
          

          <h3>Futher Explanation</h3>
          
            <a href="../explanations/the-monad-orville-typeclass.html">The MonadOrville Typeclass (Upcoming)</a>
          
            <a href="../explanations/building-sql-expressions.html">Building SQL Expressions (Upcoming)</a>
          
            <a href="../explanations/fighting-n-plus-one-queries-with-plans.html">Fighting N+1 Queries with Plans (Upcoming)</a>
          

          <h3>API Reference</h3>
          <a href="https://hackage.haskell.org/package/orville-postgresql">See Hackage</a>

          <h3>Other Links</h3>
          <a href="../contact.html">Contact</a>
        </nav>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
      </section>

      <main role="main">
        <h1>Using Migrations</h1>
        <article>
  <section>
    <h2 id="adding-a-new-non-nullable-column">Adding a new non-nullable column</h2>
<p>We’ll show how, to add a new non-nullable column:</p>
<ol type="1">
<li>first, we create the initial version of the table without the ‘new’ column</li>
<li>we then add the column, but only as <em>nullable</em></li>
<li>we make sure all values are present on the nullable column</li>
<li>we then migrate the column to be non-nullable</li>
</ol>
<p>You’ll need a Haskell project named <code>using-migrations</code> for this tutorial.
The setup is identical to the setup in <a href="getting-started.html">Getting Started</a>
aside from the package name, so we’ll avoid explaining it again here. Instead
we’ll get straight on creating our <code>src/Main.hs</code> file.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">module</span> <span class="dt">Main</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  ( main</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  ) <span class="kw">where</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Orville.PostgreSQL</span> <span class="kw">as</span> <span class="dt">O</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Orville.PostgreSQL.AutoMigration</span> <span class="kw">as</span> <span class="dt">AutoMigration</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Orville.PostgreSQL.Raw.RawSql</span> <span class="kw">as</span> <span class="dt">RawSql</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span>           <span class="dt">Control.Monad.IO.Class</span> (<span class="dt">MonadIO</span>(liftIO))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="kw">import</span> <span class="kw">qualified</span> <span class="dt">Data.Int</span> <span class="kw">as</span> <span class="dt">Int</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Foo1</span> <span class="ot">=</span> <span class="dt">Foo1</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> foo1Id ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Foo2</span> <span class="ot">=</span> <span class="dt">Foo2</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> foo2Id ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> foo2Age ::</span> <span class="dt">Maybe</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">data</span> <span class="dt">Foo3</span> <span class="ot">=</span> <span class="dt">Foo3</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  {<span class="ot"> foo3Id ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  ,<span class="ot"> foo3Age ::</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">deriving</span> <span class="dt">Show</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="ot">fooIdField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>fooIdField <span class="ot">=</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;id&quot;</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="ot">fooAgeField ::</span> <span class="dt">O.FieldDefinition</span> <span class="dt">O.NotNull</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>fooAgeField <span class="ot">=</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  O.integerField <span class="st">&quot;age&quot;</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="ot">foo1Marshaller ::</span> <span class="dt">O.SqlMarshaller</span> <span class="dt">Foo1</span> <span class="dt">Foo1</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>foo1Marshaller <span class="ot">=</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Foo1</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> O.marshallField foo1Id fooIdField</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="ot">foo2Marshaller ::</span> <span class="dt">O.SqlMarshaller</span> <span class="dt">Foo2</span> <span class="dt">Foo2</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>foo2Marshaller <span class="ot">=</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Foo2</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> O.marshallField foo2Id fooIdField</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField foo2Age (O.nullableField fooAgeField)</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="ot">foo3Marshaller ::</span> <span class="dt">O.SqlMarshaller</span> <span class="dt">Foo3</span> <span class="dt">Foo3</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>foo3Marshaller <span class="ot">=</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">Foo3</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;$&gt;</span> O.marshallField foo3Id fooIdField</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">&lt;*&gt;</span> O.marshallField foo3Age fooAgeField</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Note how the following tables have the same SQL table names. Imagine that
<code>table1</code> is the initial version of the table, which then is changed to
<code>table2</code>, and so on. In practice, they can keep their Haskell names, since they
won’t need to co-exist, like they do in this document.</p>
<p>Orville’s AutoMigration tool sees that the difference between the tables is,
that the second table has an additional column, and it will generate and
execute the DDL to add the column. It needs to be nullable, because the database won’t
have any values for it when it is added.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ot">table1 ::</span> <span class="dt">O.TableDefinition</span> (<span class="dt">O.HasKey</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span>) <span class="dt">Foo1</span> <span class="dt">Foo1</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>table1 <span class="ot">=</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  O.mkTableDefinition <span class="st">&quot;migration_demo1&quot;</span> (O.primaryKey fooIdField) foo1Marshaller</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ot">table2 ::</span> <span class="dt">O.TableDefinition</span> (<span class="dt">O.HasKey</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span>) <span class="dt">Foo2</span> <span class="dt">Foo2</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>table2 <span class="ot">=</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  O.mkTableDefinition <span class="st">&quot;migration_demo1&quot;</span> (O.primaryKey fooIdField) foo2Marshaller</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ot">table3 ::</span> <span class="dt">O.TableDefinition</span> (<span class="dt">O.HasKey</span> <span class="dt">Int</span><span class="op">.</span><span class="dt">Int32</span>) <span class="dt">Foo3</span> <span class="dt">Foo3</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>table3 <span class="ot">=</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  O.mkTableDefinition <span class="st">&quot;migration_demo1&quot;</span> (O.primaryKey fooIdField) foo3Marshaller</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>Now let’s add a <code>main</code> function invokes Orville’s auto-migration tool to
demonstrate making changes to the table.</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ot">main ::</span> <span class="dt">IO</span> ()</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>main <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  pool <span class="ot">&lt;-</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    O.createConnectionPool</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="dt">O.ConnectionOptions</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>          { O.connectionString <span class="ot">=</span> <span class="st">&quot;host=localhost user=postgres password=postgres&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>          , O.connectionNoticeReporting <span class="ot">=</span> <span class="dt">O.DisableNoticeReporting</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>          , O.connectionPoolStripes <span class="ot">=</span> <span class="dt">O.OneStripePerCapability</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>          , O.connectionPoolLingerTime <span class="ot">=</span> <span class="dv">10</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>          , O.connectionPoolMaxConnections <span class="ot">=</span> <span class="dt">O.MaxConnectionsPerStripe</span> <span class="dv">1</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>          }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  O.runOrville pool <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    O.executeVoid <span class="dt">O.DDLQuery</span> (RawSql.fromString <span class="st">&quot;DROP TABLE IF EXISTS migration_demo1&quot;</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    AutoMigration.autoMigrateSchema AutoMigration.defaultOptions [ <span class="dt">AutoMigration.SchemaTable</span> table1 ]</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.insertEntity table1 <span class="dt">Foo1</span> { foo1Id <span class="ot">=</span> <span class="dv">0</span> }</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    AutoMigration.autoMigrateSchema AutoMigration.defaultOptions [ <span class="dt">AutoMigration.SchemaTable</span> table2 ]</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    _ <span class="ot">&lt;-</span> O.updateEntity table2 <span class="dv">0</span> <span class="dt">Foo2</span> { foo2Id <span class="ot">=</span> <span class="dv">0</span>, foo2Age <span class="ot">=</span> <span class="dt">Just</span> <span class="dv">91</span> }</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    AutoMigration.autoMigrateSchema AutoMigration.defaultOptions [ <span class="dt">AutoMigration.SchemaTable</span> table3 ]</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">.</span> <span class="fu">print</span> <span class="op">=&lt;&lt;</span> O.findEntity table3 <span class="dv">0</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<h1 id="dropping-a-column">Dropping a column</h1>
<p>Orville won’t automatically drop a column in the SQL database that isn’t in the SqlMarshaller.
The column will just be ignored.</p>
<p>We have to tell Orville explicitly about the columns that are safe to drop.
This is done using the <code>dropColumns</code> combinator. Add this to the bottom of the
<code>main</code> function:</p>
<div class="codeblock-label">
src/Main.hs : haskell
</div>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>    AutoMigration.autoMigrateSchema AutoMigration.defaultOptions [ <span class="dt">AutoMigration.SchemaTable</span> <span class="op">$</span> O.dropColumns [<span class="st">&quot;age&quot;</span>] table1 ]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    liftIO <span class="op">.</span> <span class="fu">print</span> <span class="op">=&lt;&lt;</span> O.findEntity table1 <span class="dv">0</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<h1 id="conclusion">Conclusion</h1>
<p>This concludes this tutorial. You can build an execute this as usual:</p>
<div class="codeblock-label">
shell
</div>
<div class="sourceCode" id="cb5"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> build</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">stack</span> exec using-migrations</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<p>And you should see the following output:</p>
<div class="codeblock-label">
output : plaintext
</div>
<div class="sourceCode" id="cb6"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>Just (Foo3 {foo3Id = 0, foo3Age = 91})</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>Just (Foo1 {foo1Id = 0})</span></code></pre></div>
  </section>
</article>

      </main>
    </body>
</html>
